# APIを利用したプロンプトエンジニアリング

- 自己整合性をAPIを使って実行
- MAGI ToT(マギ Think of Thought)をAPIを使って実行
- 計画と解決プロンプトをプログラムで実行

## 自己整合性をプログラムで実行

質問とヒントからなる暫定プロンプトを用意して、APIに複数回問題を解かせる。そこで得た回答を選択肢として最終判定プロンプトに埋め込み回答を得る仕組み。

### プロンプト動作サンプル

- 年齢を推論する
- メールの重要度を判定する
- ケーキの個数を計算する

### 実行方法

- self_consistency.py

``` bash
streamlit run self_consistency.py 
```

### 　自己整合性で回答をまとめるプロンプト

```
### 指示
以下の質問について、[専門家の答え]をまとめて最終的な結論と理由を提出してください。
### 質問
{question}
### 専門家の答え
{answer}
```

### 年齢を推論する

#### プロンプト

##### QUESRION

```
Q: 私が8歳の時に妹は私の半分の年齢でした。今私は40歳です。妹は何歳ですか？
A:
```

##### HINT

```
Q: 太郎は30個の飴玉のうち半分を妹に譲りました。母は10個の飴玉を妹に与えました。妹は何個の飴玉を持っていますか？
A: 妹は太郎から15個の飴玉をもらいました。母から10個の飴玉をもらいました。合計で25個の飴玉を持っています。答は25です。
Q: 太郎は30匹、次郎は25匹の鶏を飼育しています。毎年1匹づずつ増やします。太郎が40匹飼育しているなら、次郎は何匹飼育していますか？
A: 太郎はと次郎の鶏の差は35-25=5匹です。太郎が40匹飼育しているなら、経過年数は40-30=10年です。次郎は10年間毎年1匹づつ増やしているので、次郎は25+10=35匹飼育しています。答は35です。
Q: エリは10歳で、エリの父は35才です。営利が20才の時、エリの父は何才ですか？
A: エリと父の年齢差は35-10=25才です。エリが20才ならば、エリの父は25+10=35才です。答は35です。
Q: 大富豪が30代の車を所有しています。　半分を手放しばしましたが、さらに５代の車を購入しました。　今、大富豪は何代の車を所有していますか？
A: 大富豪が所有している車は30-15+5=20代です。答は20です。
```

### メールの重要度を判定する

#### プロンプト

##### QUESRION

```
経理部の担当者が、以下の入力をメールとして受信しました。
このメールの重要度を判定して次のJSON形式で出力してください。
### 出力形式:
{"重要度": "重要または普通", "理由": "ここに理由"}
### 入力:
弊社では、来月から新しいマーケティングツール「ABCD」を一斉導入します。
導入に際して、トレーニングを受ける必要があります。
講師にスケジュールを打診したいと思います。
至急、都合の良い予定を返信してください。
ただし、マーケティング業務と関係のない経理部は、トレーニングに参加する必要はありません。
時間のある時にツールの概要だけを把握しておいてください。
```

##### HINT

```
- 担当者が情報システム部であれば重要度は「普通」
- 担当者が広報部であれば重要度は「重要」
- 担当者が事業推進部であれば重要度は「重要」
```

### ケーキの個数を計算する

#### プロンプト

##### QUESRION

```
Q: 40個のケーキを1箱に4個ずつ入れて売りました。箱が6箱残りました。ケーキはいくつ売れましたか？
A:
```

##### HINT

```
Q: 太郎は30個の飴玉のうち半分を妹に譲りました。母は10個の飴玉を妹に与えました。妹はいくつ飴玉を持っていますか？
A: 妹は太郎から30/2=15個の飴玉を譲られました。母からさらに10個もらったので、25個持っています。答えは25です。
Q: 大富豪が30台の車を所有しています。半分を手放しましたが、さらに5台の車を購入しました。残りは何台ですか？
A: 大富豪が所有していた30台のうち半分を手放したので30/2=15台ですが、さらに5台増えたので、15+5=20台あります。答えは20です。
Q: 砂糖を10gずつ袋に分けます。袋が全部で40個あります。砂糖は全部で何gありますか？
A: 10gの砂糖が40袋あるので、10g*40袋=400gの砂糖があります。答えは400です。
Q: 10匹のネコが公園に居います。その後、3匹のネコ。公園にネコは何匹いますか？
A: ネコの足は4本なので、20/4=5匹です。その後3匹逃げたので、5-3=2匹で。答えは2です。
```

## MAGI ToTをプログラムで実行

3人寄れば文珠の知恵を応用した手法で、APIで問い合わせる時に３つの異なるペルソナを指定しそれぞれの意見をAIで生成する。それぞれの意見を元に最終的な意見を結論としてまとめる仕組み。

専門家の回答→それぞれの回答を簡素に要約→専門家同士で協議→それその結果をもとに最終回答を出す

### プロンプト動作サンプル

- 今日のランチを決める
- 持ち家か賃貸かを議論する

### 実行方法

- magi_tot.py

``` bash
streamlit run magi_tot.py 
```

### 　専門家に問い合わせるプロンプト

```
### 役割
質問に真摯に向き合い、{role}らしい意見を述べます。

### 指示
まず以下の質問に対する答えについて、賛否と意見を述べてください。
### 質問
{question}

### 答え
```

### 　各回答から専門家が意見をするプロンプト

```
### 指示
あなたは{role}の代表です。建設的で率直な意見を述べます。
まず以下の質問に対する答えについて、賛否と意見を述べてください。

### 質問
{question}

### 答え
専門家それぞれの回答の{summary}

### 出力例
賛成 or 反対
理由
```

### 　回答をまとめるプロンプト

```
### 専門家({role})の回答
{answer1}
### 専門家({role})の回答
{answer2}
### 専門家({role})の回答
{answer3}

### 指示
下の質問に答えてください
ただし以下の専門家たちの意見を要約して簡潔な結論と理由を提出してください
あなたは善良で公平な裁判官です。専門家の意見を元に結論を出します。
### 質問
{question}
### まとめた答え
```

### 今日のランチを決める

#### プロンプト

##### QUESRION

```
事務職30代男性がメニューの豊富なファミレスでランチをします。
今日頼むべきメニュー(日替わり/カレー/ハンバーグ/ラーメンなど)を提案してください。
簡潔にメニューとその理由を一言で答えてください。
```

##### PERSONA

```
栄養士, 愛情溢れる母親, 若い女性
```

### 持ち家か賃貸かを議論する

#### プロンプト

##### QUESRION

```
持ち家か賃貸か、どちらが良いですか？
できるだけ簡潔に答えと理由を提案してください。
家族構成: 30代夫婦で子供が2人
世帯年収: 500万円
居住地域: 東京近郊
```

##### PERSONA

```
不動産の専門家, 経営コンサルタント, 賢い母親
```

## 計画と解決プロンプトをプログラムで実行

- 計画の立案：問題を整理して全体のタスクをより小さなサブタスクに分割
- 計画の実行：立案された計画に従ってサブタスクを実行

問題解決をPythonのプログラムを用いて行うもになっている。

### プロンプト動作サンプル

- 蝋燭の長さを計算する問題
- プリンとチョコの組み合わせを考える問題

### 実行方法

- plan_and_solve.py

``` bash
streamlit run plan_and_solve.py 
```

### 　計画と解決プロンプト(Plan-and-Solve)のためのプロンプト

```
### 指示:
以下の質問について次の手順通り考えてください。

### 手順:
1. 問題を整理してください。
2. 問題を解決する計画を立ててください。
3. 上記に基づいてPythonプログラムを作ってください。

### 質問:
{question}

### 出力例:
'```python
# ここにPythonのプログラム
'```
```

###  蝋燭の長さを計算する問題

---

計算の過程は以下の通りです。

#### 1. Aのロウソクの燃え尽きる時間を求める
- Aのロウソクの長さは20cm、1分間に1.25cmずつ短くなるため、Aが燃え尽きるまでにかかる時間は以下の式で求められます。

\[
\text{Aの燃焼時間} = \frac{Aの長さ}{燃焼速度} = \frac{20 \, \text{cm}}{1.25 \, \text{cm/分}} = 16 \, \text{分}
\]

Aのロウソクは16分で燃え尽きます。

#### 2. Bのロウソクの長さを求める
- Aが燃え尽きた時点で、Bのロウソクはもともとの長さの3分の2だけ残っています。これは、Bのもとの長さがAの1.5倍であることを意味します。

\[
Bの長さ = \frac{3}{2} \times Aの長さ = \frac{3}{2} \times 20 \, \text{cm} = 30 \, \text{cm}
\]

したがって、Bのロウソクの長さは30cmです。

#### 3. Bの燃え尽きるまでの時間を求める
- Aのロウソクが燃え尽きるまでに16分かかり、その時点でBは3分の2だけ残っています。つまり、Bが燃え尽きるまでの時間は、Aの燃焼時間の1.5倍です。

\[
Bの燃焼時間 = \frac{3}{2} \times \text{Aの燃焼時間} = \frac{3}{2} \times 16 \, \text{分} = 24 \, \text{分}
\]

したがって、Bのロウソクが燃え尽きるまでには24分かかります。

#### 結論
- Bの長さは **30.0cm**
- Bが燃え尽きるまでの時間は **24.0分**

---

#### プロンプト

##### QUESRION

```
### 質問:
AとBの2本のロウソクがあります。
それぞれ火を点けると1分間1.25cmずつ短くなります。
Aは20cmですが、同時に火を点けてBが3分の2になった時、Aは燃え尽きました。
Bのロウソクの長さと燃え尽きるまでの時間を計算してください。
なお、以下のJSON形式(ensure_ascii=False)で答えを出力してください。
{"Bの長さ": "答えcm", "Bが燃え尽きるまでの時間": "答え分"}

### ヒント:
火を点けて、Aの長さが0cmになった時、Bは2/3だけ残っていました。
つまり、Bの長さはAの3/2で、燃えつきる時間も3/2倍です。
```

###  プリンとチョコの組み合わせを考える問題

---

計算の過程は以下の通りです。

#### 1. 合計金額を求める
1万円を支払い、お釣りは450円でしたので、実際に支払った金額は以下の式で求められます。

\[
\text{支払額} = 10000 \, \text{円} - 450 \, \text{円} = 9550 \, \text{円}
\]

したがって、チョコとプリンの合計金額は9550円です。

#### 2. 二重ループを使って解を探索
プリン1個の価格は320円、チョコ1個の価格は210円です。そこで、プリンとチョコをそれぞれ何個買ったのかを探索するため、二重ループを用いて以下のように計算します。

- プリンの個数を0個から順に増やしていきます。
- その各プリンの個数に対して、残りの金額でチョコを買うための個数を探索します。

例えば、プリンを20個、チョコを15個購入した場合、合計金額は以下のように計算されます。

\[
\text{合計金額} = 20 \times 320 \, \text{円} + 15 \times 210 \, \text{円} = 6400 \, \text{円} + 3150 \, \text{円} = 9550 \, \text{円}
\]

これで合計金額が9550円となり、条件に一致します。

#### 3. 解
- プリンの個数は **20個**
- チョコの個数は **15個**

---

#### プロンプト

##### QUESRION

```
### 質問:
お店で320円のプリンと210円のチョコをいくつかを買って1万円を支払いました。
お釣りは450円でした。チョコとプリンを何個ずつ買ったのでしょうか？
### ヒント:
プリンとチョコをそれぞれ1つずつ加算して、二重ループ内で答えを求めるプログラムを作ってください。
```

---
 続き
---
## クラウディング外部リソースをツールとして利用する

予め対応可能なタスクに応じた処理を作成して、質問の内容に応じて切り替えることを質問から生成AIにて判断して処理を行う

例えば、生成AIが学習していない最新の情報をWebに検索したり、苦手な計算をPythonなどの別の処理で行うことで弱点を補う手法

### プロンプト動作サンプル

- 時間を問い合わせる
- 計算してもらう
- 最新の情報を検索する

### 実行方法

- select_tool_wikipedia.py

``` bash
streamlit run select_tool_wikipedia.py 
```

### ツールを切り替えるためのプロンプト

```
### 指示:
目標を達成するために、与えられたツールの一覧から相応しいツールを選んでください。
### ツール一覧:
- 検索: 指定したキーワードを検索します。
  - 引数:
    - キーワード: 検索キーワード
- 現在時刻: 現在時刻を返します。
- 計算機: 引数に与えた計算式を計算します
  - 引数:
    - 計算式: 計算式を指定
### 目標:
```{input}```
### 出力例:
JSON形式で出力してください。
'```json
{"行動": "ツール名", "引数": "ここに引数", "備考": "ここに備考"}
'```
```

#### 検証

#### 現在時刻を問い合わせる

``` text
今は何時ですか？
```

#### 現在時刻を利用した問い合わせ

``` text
後何時間で日付が変わりますか？
```

#### 計算をプログラム利用した問い合わせ

``` text
4300円の柿を30箱と3000円のイチゴを50箱買いました。合計でいくらですか？
```

#### Wikipediaを利用した問い合わせ

``` text
現職の総理大臣の名前を教えてください
```

**Wikipedaの情報が大きく、下の方にしか歴代総理の氏名が表示されていないのでうまくコンテキストを利用できない**

## ベクトルデータベースを利用した長文の要約


---- 

# 文字起こし

## 内容

#### 出力結果 その1

- kotoba-tech/kotoba-whisper-v2.1 での文字起こし

``` text
=== 文字起こし結果 === 
ごちそう幹事者の日経新聞です
本日の会見時間はいつも通り45分を予定しており最大60分とさせていただければと思います
できる限り多くの方に質問していただくため質問の数を絞ったり内容もできる限り完結にするなど皆様のご協力をお願いできればと思います
また司会者から指名された際にはどの席から発言しているか分かるよう挙手したまま社名と指名を述べた上で質問いただくなどご配慮をお願いします
では本日の金融政策決定会合の内容について展望レポートの内容を含めて総裁ご説明をお願いいたします
今日の会合ですが無担保コールレートを追わないとものを0.25%程度で推移するようなかすという金融手上調節方針を維持することを全一致で決定いたしました。
天保レポートも公表しましたので、最初に経済物価の現状と先行きについて、天保レポートに沿って簡単に説明をします
まず我が国の景気の現状ですが一部に弱めの動きも見られますが緩やかに回復していると判断しました
先行きについては海外経済が緩やかな成長を続けるもとで緩和的な金融環境などを背景に所得から資質性の前向きの循環メカニズムが徐々に強まることから�潜在成長率を上回る成長を続けると考えられます。
```

- 4oでの文字起こし結果の補正

``` text
=== 修正した結果 === 
ごちそう幹事者の日経新聞です。
本日の会見時間はいつも通り45分を予定しており、最大60分とさせていただければと思います。
できる限り多くの方に質問していただくため、質問の数を絞ったり、内容もできる限り簡潔にするなど、皆様のご協力をお願いできればと思います。
また、司会者から指名された際には、どの席から発言しているか分かるよう、挙手したまま社名と氏名を述べた上で質問いただくなど、ご配慮をお願いします。
では、本日の金融政策決定会合の内容について、展望レポートの内容を含めて総裁ご説明をお願いいたします。

今日の会合ですが、無担保コールレートを0.25%程度で推移するような金融調節方針を維持することを全会一致で決定いたしました。
展望レポートも公表しましたので、最初に経済物価の現状と先行きについて、展望レポートに沿って簡単に説明をします。

まず、我が国の景気の現状ですが、一部に弱めの動きも見られますが、緩やかに回復していると判断しました。
先行きについては、海外経済が緩やかな成長を続けるもとで、緩和的な金融環境などを背景に、所得から支出への前向きの循環メカニズムが徐々に強まることから、潜在成長率を上回る成長を続けると考えられます。
```


#### 出力結果 その２

- openai/whisper-large-v3-turbo での文字起こし

``` text
=== 文字起こし結果 === 
はい幹事社の日経新聞です
本日の会見時間はいつも通り45分を予定しており最大60分とさせていただければと思います
できる限り多くの方に質問していただくため質問の数を絞ったり内容もできる限り簡潔にするなど皆様のご協力をお願いできればと思います
また司会者から指名された際にはどの席から発言しているか分かるよう挙手したまま社名と氏名を金融政策決定会合の内容について、展望レポートの内容を含めて、総裁ご説明をお願いいたします。
今日の会合ですが無担保コールレートを追わないとものを0.25%程度で推移するよう促すという金融市場調節方針を維持することを全一致で決定いたしました
展望レポートも公表しましたので最初に経済物価の現状と先行きについて展望レポートに沿って簡単に説明します
まず我が国の景気の現状ですが一部に弱めの動きも見られますが緩やかに回復していると判断しました先行きについては海外経済が緩やかな成長を続けるもとで緩和的な市長次に物価です
```

- 4oでの文字起こし結果の補正

``` text
=== 修正した結果 === 
はい、幹事社の日経新聞です。本日の会見時間はいつも通り45分を予定しており、最大60分とさせていただければと思います。
できる限り多くの方に質問していただくため、質問の数を絞ったり、内容もできる限り簡潔にするなど、皆様のご協力をお願いできればと思います。
また、司会者から指名された際には、どの席から発言しているか分かるよう、挙手したまま社名と氏名をお伝えください。
金融政策決定会合の内容について、展望レポートの内容を含めて、総裁ご説明をお願いいたします。

今日の会合ですが、無担保コールレートを0.25%程度で推移するよう促すという金融市場調節方針を維持することを全会一致で決定いたしました。
展望レポートも公表しましたので、最初に経済・物価の現状と先行きについて、展望レポートに沿って簡単に説明します。

まず、我が国の景気の現状ですが、一部に弱めの動きも見られますが、緩やかに回復していると判断しました。
先行きについては、海外経済が緩やかな成長を続けるもとで、緩和的な市場環境が続くと見込んでいます。
次に物価です。
```


#### 出力結果 その3

##### 話者１

- pyannote/speaker-diarization-3.1 で話者を分割しての文字起こし

``` text
=== 文字起こし結果 === 
幹事社の日経新聞です
本日の会見時間はいつも通り45分を予定しており最大60分とさせていただければと思います
できる限り多くの方に質問していただくため質問の数を絞ったり内容もできる限り簡潔にするなど皆様のご協力をお願いできればと思います
また司会について、展望レポ合の内容について展望レポートの内容を含めて総裁ご説明をお願いいたします
```

- 4oでの文字起こし結果の補正

``` text
=== 修正した結果 ===
幹事社の日経新聞です。
本日の会見時間はいつも通り45分を予定しており、最大60分とさせていただければと思います。
できる限り多くの方に質問していただくため、質問の数を絞ったり、内容もできる限り簡潔にするなど、皆様のご協力をお願いできればと思います。
また、司会について、展望レポートの内容を含めて総裁ご説明をお願いいたします。
```

##### 話者２

- pyannote/speaker-diarization-3.1 で話者を分割しての文字起こし

``` text
=== 文字起こし結果 === 
今日の会合ですが無担保コールレートを上ないとものを0.25%程度で推移するよう促すという金融市場調整方針を維持することを全一致で決定いたしました
展望レポートも公表しましたので最初に経済物価の現状と先行きについて市民の中での山本一郎君
先行きについては海外経済が緩やかな成長を続けるもとで緩和的な金融環境などを背景に所得から出世の前向きの循環メカニズムが徐々に強まることから潜在成長率を上回る成長を続けると考えられます
次に物価です
```

- 4oでの文字起こし結果の補正

``` text
=== 修正した結果 === 
今日の会合ですが、無担保コールレートを0.25%程度で推移するよう促すという金融市場調整方針を維持することを全会一致で決定いたしました。
展望レポートも公表しましたので、最初に経済・物価の現状と先行きについて説明いたします。
先行きについては、海外経済が緩やかな成長を続けるもとで、緩和的な金融環境などを背景に、所得から支出への前向きの循環メカニズムが徐々に強まることから、潜在成長率を上回る成長を続けると考えられます。
次に物価です。
```